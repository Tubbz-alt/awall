#!/usr/bin/lua

--[[
Alpine Wall
Copyright (C) 2012 Kaarle Ritvanen
Licensed under the terms of GPL2
]]--

require 'alt_getopt'
require 'lfs'
require 'stringy'

short_opts = 'o:V'
long_opts = {['output-dir']='o',
	     verify='V'}

if stringy.endswith(arg[0], '/awall-cli') then
   basedir = string.sub(arg[0], 1, -11)
   input = {basedir..'/json'}

   short_opts = short_opts..'i:'
   long_opts['input-dir'] = 'i'
end

for switch, value in pairs(alt_getopt.get_opts(arg, short_opts, long_opts)) do
   if switch == 'i' then table.insert(input, value)
   elseif switch == 'o' then
      iptdir = value
      ipsfile = value..'/ipset'
   elseif switch == 'V' then verify = true
   else assert(false) end
end


require 'awall'
awall.loadmodules(basedir)

config = awall.Config.new(input)
if verify then config:test() end
config:dump(iptdir, ipsfile)
